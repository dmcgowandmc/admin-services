---
#Configure the base packages, mount the EFS and determine if jenkins installation already exists on EFS or not
#IMPORTANT: We want a primary / failover configuration where if a host fails, a new one in it's place will pick up the installation in the EFS and pick up from there. To make this work, all wuser data will be stored in /opt/jenkins_data on EFS mount
#All of these tasks will be run locally
- hosts: adminstack
  vars:
    region: ap-southeast-2
  tasks:
  - name: "Install unzip"
    apt:
      name: unzip
      state: present
  - name: "Install rsync"
    apt:
      name: rsync
      state: present
  - name: "Install curl"
    apt:
      name: curl
      state: present
  - name: "Install Open JDK 1.8"
    apt:
      name: openjdk-8-jdk
      state: present
  - name: "Install nfs-common"
    apt:
      name: nfs-common
      state: present
  - name: "Get Jenkins IO Key"
    get_url:
      url: "https://pkg.jenkins.io/debian/jenkins.io.key"
      dest: "{{ playbook_dir }}/jenkins.io.key"
  - name: "Add Jenkins IO Key"
    apt_key:
      file: "{{ playbook_dir }}/jenkins.io.key"
      state: present
  - name: "Add Jenkins Repository"
    apt_repository:
      repo: "deb http://pkg.jenkins.io/debian-stable binary/"
      filename: "jenkins.list"
      state: present
  - name: "Install Jenkins"
    apt:
      name: jenkins
      update_cache: yes
      state: present
  - name: "Stop Jenkins"
    service:
      name: jenkins
      state: stopped
  - name: "Jenkins Config - Create Directory"
    file:
      path: /opt/jenkins_data
      state: directory
      mode: 0755
      owner: jenkins
      group: jenkins
  - name: "Jenkins Config - Mount EFS" #NOTE: NEED TO LOOK AT REPLACEING WITH ANSIBLE MOUNT MODULE
    command: "mount -t nfs4 -o nfsvers=4.1,rsize=1048576,wsize=1048576,hard,timeo=600,retrans=2 {{ efsfqdn }}.efs.{{ region }}.amazonaws.com:/ /opt/jenkins_data"
  - name: "Jenkins Config - Alter Permission Upload"
    file:
      path: /opt/jenkins_data
      state: directory
      owner: jenkins
      group: jenkins
      mode: 0755
  - name: "Jenkins Config - Change Home Directory"
    lineinfile:
      line: "JENKINS_HOME=/opt/jenkins_data"
      regexp: "^JENKINS_HOME="
      dest: "/etc/default/jenkins"
      state: present
  - name: "Jenkins Config - Check if Installation Already Exists"
    find:
      path: "/opt/jenkins_data"
    register: jenkins_data
  - name: "Jenkins Config - Install Exists - Start Jenkins Service"
    service:
      name: jenkins
      state: started
    when: jenkins_data.files|length > 0
  - name: "Jenkins Config - Install Exists - Terminate. Not further action required"
    fail:
      msg: "Existing Install. Stopping. Note we haven't actually failed but other attempts to stop the scripts don't seem to work. So don't freak out about this message"
  - name: "Jenkins Config - No Install - Start Jenkins Service with Setup Wizard"
    service:
      name: jenkins
      state: started
  - pause:
      seconds: 20
  - name: "Jenkins Config - No Install - Setup Default Configuration"
    jenkinscfg.py:
      username: "{{ username }}"
      password: "{{ password }}"
      email: "{{ email }}"
    when: jenkins_data.files|length == 0
- include: init-aws.yml #This script will complete the setup of AWS components we could complete in the init cloud formation template


#ansible-playbook -i inventory/adminstack init-adminstack.yml --extra-vars "efsfqdn=<efs> username=<username> password=<password> email=<email> stackname=<stackname>" -vvvv